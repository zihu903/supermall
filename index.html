<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证回调</title>
    
    <!-- 引入 UniApp SDK -->
    <!-- 注意：这个地址必须能访问，且版本匹配 -->
    <script src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.5.js"></script>
    
</head>
<body>
    <script>
        console.log('定义发送消息的函数，sendAuthSuccess');
        // 定义发送消息的函数
        function sendAuthSuccess() {
            // 1. 检查 uni 对象是否存在，且 postMessage 方法是否存在
            if (typeof uni !== 'undefined' && typeof uni.postMessage === 'function') {
                console.log('UniApp 环境就绪，发送认证成功消息');
                
                uni.postMessage({
                    data: {
                        action: 'authSuccess',
                        message: '认证成功',
                        timestamp: new Date().getTime() // 加个时间戳方便调试，防止缓存
                    }
                });

                // 可选：发送后尝试关闭或返回
                // uni.navigateBack();
                
                // 清除轮询定时器
                if (window.authTimer) {
                    clearInterval(window.authTimer);
                    window.authTimer = null;
                }
                return true;
            } else {
                console.log('等待 UniApp SDK 加载...');
            }
            return false;
        }
        console.log('方案 A：监听 SDK 发出的就绪事件（最优雅）');
        // 方案 A：监听 SDK 发出的就绪事件（最优雅）
        document.addEventListener('UniAppJSBridgeReady', function() {
            console.log('捕获 UniAppJSBridgeReady 事件');
            sendAuthSuccess();
        });
        console.log('方案 B：轮询兜底（防止事件监听失效，最稳妥）');
        // 方案 B：轮询兜底（防止事件监听失效，最稳妥）
        // 页面加载完成后开始轮询
        window.onload = function() {
            // 立即尝试一次
            if (!sendAuthSuccess()) {
                // 如果没准备好，开启轮询
                window.authTimer = setInterval(function() {
                    sendAuthSuccess();
                }, 300); // 每 300ms 检查一次
            }
        };
    </script>
</body>
</html>
